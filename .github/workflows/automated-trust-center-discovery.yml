name: Automated Trust Center Discovery

on:
  schedule:
    - cron: '0 9 * * 1'      # Every Monday at 9 AM UTC
  workflow_dispatch:  # Manual trigger option
    inputs:
      max_companies:
        description: 'Max companies to test (leave empty for all new)'
        required: false
        type: string
        default: ''
      full_refresh:
        description: 'Force full refresh (test all companies)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  discover-trust-centers:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Determine run type
        id: run-type
        run: |
          # Check if this is the first Monday of the month (monthly full refresh)
          CURRENT_DAY=$(date +%d)
          if [ "$CURRENT_DAY" -le 7 ]; then
            echo "run_type=monthly_full" >> $GITHUB_OUTPUT
            echo "ðŸ”„ Monthly full refresh detected (1st Monday of month)"
          else
            echo "run_type=weekly_incremental" >> $GITHUB_OUTPUT
            echo "ðŸ“… Weekly incremental run detected"
          fi
          
          # Override with manual input if provided
          if [ "${{ github.event.inputs.full_refresh }}" == "true" ]; then
            echo "run_type=manual_full" >> $GITHUB_OUTPUT
            echo "ðŸ”§ Manual full refresh requested"
          fi

      - name: Run discovery
        run: |
          cd scripts/trust-center-discovery
          
          if [ "${{ steps.run-type.outputs.run_type }}" == "monthly_full" ] || [ "${{ steps.run-type.outputs.run_type }}" == "manual_full" ]; then
            echo "ðŸš€ Running FULL REFRESH (testing all companies)"
            node incremental-discovery.js --full-refresh
          elif [ -n "${{ github.event.inputs.max_companies }}" ]; then
            echo "ðŸ§ª Testing ${{ github.event.inputs.max_companies }} companies (manual limit)"
            node incremental-discovery.js --maxCompaniesToTest ${{ github.event.inputs.max_companies }}
          else
            echo "ðŸ“ˆ Running INCREMENTAL discovery (new companies only)"
            node incremental-discovery.js
          fi

      - name: Check for high confidence results
        id: check-results
        run: |
          if [ -f "scripts/trust-center-discovery/trust-centers-ready-to-add.json" ]; then
            HIGH_CONFIDENCE_COUNT=$(node -e "
              const data = JSON.parse(require('fs').readFileSync('scripts/trust-center-discovery/trust-centers-ready-to-add.json', 'utf8'));
              console.log(data.highConfidence ? data.highConfidence.length : 0);
            ")
            echo "high_confidence_count=$HIGH_CONFIDENCE_COUNT" >> $GITHUB_OUTPUT
            echo "Found $HIGH_CONFIDENCE_COUNT high confidence trust centers"
          else
            echo "high_confidence_count=0" >> $GITHUB_OUTPUT
            echo "No high confidence results found"
          fi

      - name: Create Auto-PR for high confidence results
        if: steps.check-results.outputs.high_confidence_count > 0
        run: |
          # Create a new branch for the auto-PR
          BRANCH_NAME="auto-discover-trust-centers-$(date +%Y%m%d-%H%M%S)"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Create and checkout new branch
          git checkout -b $BRANCH_NAME
          
          # Process high confidence results
          node scripts/utilities/process-high-confidence.js
          
          # Regenerate JSON/CSV
          npm run generate
          
          # Commit changes
          git add -A
          
          RUN_TYPE="${{ steps.run-type.outputs.run_type }}"
          if [ "$RUN_TYPE" == "monthly_full" ]; then
            COMMIT_MSG="Monthly full refresh: Auto-discover ${{ steps.check-results.outputs.high_confidence_count }} high confidence trust centers"$'\n\n'"- Monthly full refresh of all YC companies"$'\n'"- Added ${{ steps.check-results.outputs.high_confidence_count }} companies with 95%+ confidence scores"$'\n'"- All entries verified via CNAME lookup to known trust center hosts"$'\n'"- Catches companies that added trust centers since last month"$'\n'"- Ready for review and merge"
          else
            COMMIT_MSG="Auto-discover ${{ steps.check-results.outputs.high_confidence_count }} high confidence trust centers"$'\n\n'"- Added ${{ steps.check-results.outputs.high_confidence_count }} companies with 95%+ confidence scores"$'\n'"- All entries verified via CNAME lookup to known trust center hosts"$'\n'"- Generated from weekly YC company discovery run"$'\n'"- Ready for review and merge"
          fi
          
          git commit -m "$COMMIT_MSG"

      - name: Create Pull Request
        if: steps.check-results.outputs.high_confidence_count > 0
        run: |
          # Create PR using our script
          node scripts/utilities/create-pr.js "${{ steps.run-type.outputs.run_type }}" "${{ steps.check-results.outputs.high_confidence_count }}"

      - name: Upload discovery results
        uses: actions/upload-artifact@v4
        with:
          name: discovery-results-${{ github.run_number }}
          path: |
            scripts/trust-center-discovery/trust-center-discovery-results.json
            scripts/trust-center-discovery/trust-center-discovery-results.csv
            scripts/trust-center-discovery/trust-centers-ready-to-add.json
          retention-days: 30

      - name: Summary
        run: |
          RUN_TYPE="${{ steps.run-type.outputs.run_type }}"
          COUNT="${{ steps.check-results.outputs.high_confidence_count }}"
          
          echo "## ðŸŽ‰ Trust Center Discovery Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$RUN_TYPE" == "monthly_full" ]; then
            echo "**ðŸ”„ Monthly Full Refresh Results**" >> $GITHUB_STEP_SUMMARY
            echo "- **High Confidence Trust Centers Found**: $COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **Run Type**: Monthly comprehensive scan of all YC companies" >> $GITHUB_STEP_SUMMARY
            echo "- **Purpose**: Catches companies that added trust centers since last month" >> $GITHUB_STEP_SUMMARY
          else
            echo "**ðŸ“… Weekly Incremental Results**" >> $GITHUB_STEP_SUMMARY
            echo "- **High Confidence Trust Centers Found**: $COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **Run Type**: Weekly incremental scan of new YC companies" >> $GITHUB_STEP_SUMMARY
            echo "- **Purpose**: Discovers new companies with trust centers" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$COUNT" -gt 0 ]; then
            echo "âœ… **Auto-PR Created**: High confidence entries ready for review" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸŽ¯ Next Steps:" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the auto-generated PR" >> $GITHUB_STEP_SUMMARY
            echo "2. Verify company details" >> $GITHUB_STEP_SUMMARY
            echo "3. Merge when ready" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **No new high confidence trust centers found this run**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "$RUN_TYPE" == "monthly_full" ]; then
              echo "This means no existing YC companies added trust centers this month." >> $GITHUB_STEP_SUMMARY
            else
              echo "This is normal - not every week will have new companies with trust centers." >> $GITHUB_STEP_SUMMARY
            fi
          fi
